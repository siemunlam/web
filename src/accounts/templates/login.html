{% extends "base.html" %}
{% load staticfiles %}
{% load rest_framework %}

{% block title %}Login | {{ block.super }}{% endblock title %}

{% block content %}
<div id='form-container' class="container">
	<form class="form-signin" method='POST' enctype="multipart/form-data">{% csrf_token %}
		<h2 id='titulo' class="form-signin-heading text-center">Ingresar al sistema</h2>
		{% render_form form %}
		<span class='pull-right'>
			<button type="submit" class="btn btn-primary" name="ingresar">Ingresar</button>
		</span>
	</form>
</div>
{% endblock content %}

{% block extra-JS %}{{ block.super }}
<script src='{% static "js/django-cookie-handler.js" %}' type="text/javascript"></script>
<script>
    // Set fields layout
    document.getElementById('form-container').classList.add('col-md-6', 'col-md-offset-3')
	document.getElementById('titulo').style.paddingBottom = '7%'

	// CONSTANTS
	const host = '{% if request.is_secure %}https://{% else %}http://{% endif %}{{ request.get_host }}'
	const login_api_url = host + '{{ login_api }}'
	const home_url = host + '{{ home }}'
	const loginForm = document.getElementsByTagName('form')[0]
	const next = '{{ next }}'
	
	
	// OnSubmit Form
	loginForm.onsubmit = (event) => {
		const header_init = {
			'Accept': 'application/json',
			'X-CSRFToken': getCookie("csrftoken")
		}
		const fetchOptions = {
			method: 'POST',
			headers: new Headers(header_init),
			body: new FormData(loginForm),
			credentials: 'same-origin'
		}

		document.querySelector('.messages').innerHTML = ''

		fetch(login_api_url, fetchOptions)
		.then(response => {
			response.json()
			.then(jsonData => {
				if (response.ok) {
					// Redirect to next or homepage
					console.log('OK')
					if (next) {
						console.log('next')
						window.location.replace(host + next)
					} else {
						console.log('home')
						window.location.replace(home_url)
					}
				} else {
					Object.keys(jsonData).map(key => {
						// Mostrar mensaje de error
						document.querySelector('.messages').innerHTML += `
						<div class="alert alert-dismissable fade in alert-danger">${jsonData[key]}
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
						</div>`
					})
				}
			})
		})
		event.preventDefault()	// Evita el POST del formulario
	}
</script>
{% endblock extra-JS %}