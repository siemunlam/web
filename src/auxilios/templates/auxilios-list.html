{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load staticfiles %}

{% block content %}
<div class="body-header">
	<h1 class="text-center font-bold">Gestión de Auxilios</h1>
</div>

<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
	<li role="presentation" class="active"><a href="#newAuxilio" aria-controls="Nuevo auxilio" role="tab" data-toggle="tab">Nuevo Auxilio</a></li>
	<li role="presentation"><a href="#auxilios-actuales" aria-controls="Auxilios Actuales" role="tab" data-toggle="tab">Auxilios Actuales</a></li>
	<li role="presentation"><a href="#auxilios-finalizados" aria-controls="Auxilios Finalizados" role="tab" data-toggle="tab">Auxilios Finalizados</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
	<div role="tabpanel" class="tab-pane fade in active" id="newAuxilio">
		<div class="panel panel-default" id="css_footer">
			<div class="panel-header">
				<h2 class="text-center">Nueva Solicitud de Auxilio</h2>
			</div>
			<div class="panel-body">
				<form id="SolicitudForm" class="form-group" method='POST' enctype="multipart/form-data" autocomplete="off">{% csrf_token %}
					<div class="col-md-10 col-md-offset-1" id="form-container">
						{{ form|crispy }}
					</div>
				</form>
			</div>
			<!-- /panel-body -->
			<div class="panel-footer col-md-10 col-md-offset-1">
				<span class="pull-right">
					<button type="submit" form="SolicitudForm" class="btn btn-primary" name="Crear">Crear</button>
				</span>
				<button type="reset" form="SolicitudForm" id="vaciar_btn" class="btn btn-warning" name="Vaciar" onclick="empty_all()">Vaciar</button>
			</div>
			<!-- /panel-footer -->
		</div>
	</div>
	<div role="tabpanel" class="tab-pane fade" id="auxilios-actuales">
		<div class="panel panel-default">
			<!-- Default panel contents -->
			<div class="panel-header">
				<h2 class="text-center">Auxilios pendientes de atención</h2>
			</div>
			<!-- Table -->
			<table class="table table-responsive table-striped">
				<thead>
					<tr>
						<th>ID</th>
						<th>Ingresado</th>
						<th>Ubicación</th>
						<th>Estado</th>
						<th>Categorización</th>
						<th>Acciones</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<nav aria-label="Page navigation" class="text-center">
			<ul class="pagination">
				<li class="disabled">
					<a href="#" aria-label="Previous">
						<span aria-hidden="true">&laquo;</span>
					</a>
				</li>
				<li class="active"><a href="#">1</a></li>
				<li><a href="#">2</a></li>
				<li>
					<a href="#" aria-label="Next">
						<span aria-hidden="true">&raquo;</span>
					</a>
				</li>
			</ul>
		</nav>
	</div>
	<div role="tabpanel" class="tab-pane fade" id="auxilios-finalizados">
		<div class="panel panel-default">
			<!-- Default panel contents -->
			<div class="panel-header">
				<h2 class="text-center">Auxilios finalizados</h2>
			</div>
			<!-- Table -->
			<table class="table table-responsive table-striped">
				<thead>
					<tr>
						<th>ID</th>
						<th>Ingresado</th>
						<th>Finalizado</th>
						<th>Ubicación</th>
						<th>Categorización</th>
						<th>Acciones</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>
		<nav aria-label="Page navigation" class="text-center">
			<ul class="pagination">
				<li class="disabled">
					<a href="#" aria-label="Previous">
						<span aria-hidden="true">&laquo;</span>
					</a>
				</li>
				<li class="active"><a href="#">1</a></li>
				<li><a href="#">2</a></li>
				<li>
					<a href="#" aria-label="Next">
						<span aria-hidden="true">&raquo;</span>
					</a>
				</li>
			</ul>
		</nav>
	</div>
</div>
{% endblock content %}

{% block extra-JS %}{{ block.super }}
<script src='{% static "js/USIG-3.1-AutoCompleterFull.min.js" %}' type="text/javascript"></script>
<script>
	// Set fields layout
	document.getElementById('div_id_contacto').classList.add('col-md-3');
	document.getElementById('div_id_nombre').classList.add('col-md-4');
	document.getElementById('div_id_sexo').classList.add('col-md-1');
	document.getElementById('div_id_cantidad_pacientes').classList.add('col-md-2', 'col-md-offset-2');
	document.getElementById('div_id_ubicacion').classList.add('col-md-8');
	document.getElementById('div_id_ubicacion_especifica').classList.add('col-md-4');
	document.getElementById('div_id_ubicacion_coordenadas').setAttribute('hidden', 'hidden');
	document.getElementById('div_id_observaciones').classList.add('col-md-12');
	document.getElementById('id_cantidad_pacientes').classList.add('text-center', 'font-bold');
	

	// Add 'Motivo' field
	const div_motivo = document.createElement('div');
	div_motivo.setAttribute('id', 'div_id_motivo');
	div_motivo.classList.add('form-group', 'col-md-8');
	div_motivo.innerHTML = `
		<label class="control-label  requiredField">
			Motivo<span class="asteriskField">*</span>
		</label>
		<div class="controls" style="max-height: 190px;	overflow-y: auto;">
			<div class="list-group"></div>	
		</div>`
	document.getElementById('form-container').insertBefore(div_motivo, document.getElementById('div_id_observaciones'));
	
	// Add 'Motivo resumen' field
	const div_motivo_resumen = document.createElement('div');
	div_motivo_resumen.setAttribute('id', 'div_id_motivo_resumen');
	div_motivo_resumen.classList.add('form-group', 'col-md-4',);
	div_motivo_resumen.innerHTML = `
		<label for="id_motivo_resumen" class="control-label">Resumen del motivo</label>
		<div class="controls" style="max-height: 190px;	overflow-y: auto;">
			<p id="resumen-empty-msg" class='text-center' style="padding-top: 4%;">Ningún motivo seleccionado</p>
			<ul class="list-group"></ul>
		</div>`
	document.getElementById('form-container').insertBefore(div_motivo_resumen, document.getElementById('div_id_observaciones'));

	// Initial JSON data Retrieve
	loadFormattedValoresDeFactores(div_motivo.querySelector(".controls > .list-group"), "http://127.0.0.1:8000/api/vdfda", 'factorDeAjuste');
	loadFormattedValoresDeFactores(div_motivo.querySelector(".controls > .list-group"), "http://127.0.0.1:8000/api/vdfdpc", 'factorDePreCategorizacion');
	loadAuxiliosActuales(document.querySelector('#auxilios-actuales > div > table > tbody'), "http://127.0.0.1:8000/api/auxilios");
	loadAuxiliosHistoricos(document.querySelector('#auxilios-finalizados > div > table > tbody'), "http://127.0.0.1:8000/api/auxilios");
	
	
	// During tab show, retrieves data every 5 seconds
	let auxActualesTimer, auxHistoricoTimer;

	$('.nav-tabs a[href="#auxilios-actuales"]').on('show.bs.tab', event => {
		auxActualesTimer = setInterval(loadAuxiliosActuales, 5000, document.querySelector('#auxilios-actuales > div > table > tbody'), "http://127.0.0.1:8000/api/auxilios");
	});
	$('.nav-tabs a[href="#auxilios-actuales"]').on('hide.bs.tab', event => {
		clearInterval(auxActualesTimer);
	});

	$('.nav-tabs a[href="#auxilios-finalizados"]').on('show.bs.tab', event => {
		auxHistoricoTimer = setInterval(loadAuxiliosHistoricos, 5000, document.querySelector('#auxilios-finalizados > div > table > tbody'), "http://127.0.0.1:8000/api/auxilios");
	});
	$('.nav-tabs a[href="#auxilios-finalizados"]').on('hide.bs.tab', event => {
		clearInterval(auxHistoricoTimer);
	});
	// ---------------------------------------------

	function loadFormattedValoresDeFactores(dest, apiURL, factorString) {
		fetch(apiURL).then(function (response) {
			if (response.ok) {
				response.json().then(function (jsonResp) {
					let factores = {}
					jsonResp.results.map((value) => {
						if (!factores[value[factorString]]) {
							factores[value[factorString]] = [value['descripcion'],]
						}
						else {
							factores[value[factorString]].push(value['descripcion'])
						}
					});

					let motivo_content = '';

					if (Object.keys(factores)) {
						Object.keys(factores).map((key) => {
							motivo_content += '<a class="list-group-item"><strong class="list-group-item-heading">'+ key +'</strong>';
							let radios = '<p class="list-group-item-text">';
							factores[key].map((value) => {
								radios += crearBotonConValor(key, value, false, "margin-left: 2%;");
							});
							radios += crearBotonConValor(key, "Sin información", true, "margin-left: 2%;");
							motivo_content += radios + '</p></a>'
						});
					}
					else {
						motivo_content = '<p>No se encontraron '+ factorString +'</p>'
					}
					dest.innerHTML += motivo_content;
				});
			} else {
				console.log('Network response was not ok.');
			}
		}).catch(function (error) {
			console.log('There has been a problem with your fetch operation: ' + error.message);
		});
	};

	function loadAuxiliosActuales(dest, apiURL) {
		dest.innerHTML = '';
		fetch(apiURL).then(function (response) {
			if (response.ok) {
				response.json().then(function (jsonResp) {
					jsonResp.results.map((aux) => {
						let newRow = dest.insertRow(dest.rows.length);

						const date = formattedDateTime(new Date(aux.solicitud.fecha));

						const acciones = `
							<button type="button" class="btn btn-transparent btn-xs"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>
							<button type="button" class="btn btn-transparent btn-xs"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>`
						
						newRow.innerHTML = '<td>'+ aux.id +'</td><td>'+ date +'</td><td>'+ aux.solicitud.ubicacion +'</td><td>'+ aux.estado +'</td><td>'+ aux.categoria.descripcion +'</td><td>'+ acciones +'</td>';
					});
				});
			} else {
				console.log('Network response was not ok.');
			}
		}).catch(function (error) {
			console.log('There has been a problem with your fetch operation: ' + error.message);
		});
	};

	function loadAuxiliosHistoricos(dest, apiURL) {
		dest.innerHTML = '';
		fetch(apiURL).then(function (response) {
			if (response.ok) {
				response.json().then(function (jsonResp) {
					jsonResp.results.map((aux) => {
						let newRow = dest.insertRow(dest.rows.length);

						const inicial = formattedDateTime(new Date(aux.solicitud.fecha));
						const final = formattedDateTime(new Date(aux.final));

						const acciones = `
							<button type="button" class="btn btn-transparent btn-xs"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>`
						
						newRow.innerHTML = '<td>'+ aux.id +'</td><td>'+ inicial +'</td><td>'+ inicial/*final*/ +'</td><td>'+ aux.solicitud.ubicacion +'</td><td>'+ aux.categoria.descripcion +'</td><td>'+ acciones +'</td>';
					});
				});
			} else {
				console.log('Network response was not ok.');
			}
		}).catch(function (error) {
			console.log('There has been a problem with your fetch operation: ' + error.message);
		});
	};

	function crearBotonConValor(factor, valor, is_checked, style) {
		if(is_checked)
			return '<input form="none" onclick="updateResumen(this);" style="'+ style +'" type="radio" name="'+ factor +'" value="'+ valor +'" checked />'+ valor;
		else
			return '<input form="none" onclick="updateResumen(this);" style="'+ style +'" type="radio" name="'+ factor +'" value="'+ valor +'"/>'+ valor
	};

	function checkStatus(response) {
		if(response.ok) {
			return Promise.resolve(response);
		} else {
			console.log('Response was not OK');
			return Promise.reject(new Error(response.statusText));
		}
	};

	/*
	 *    USIG 3.1 AutoCompleter & GeoCoder
	 *	  https://usig.buenosaires.gob.ar/
	 * -- usado para buscador de calles y coordenadas --
	 */
	const ac = new usig.AutoCompleter('id_ubicacion', {
		skin: 'bootstrap',
		afterGeoCoding: function (punto) {
			if(punto instanceof usig.Punto) {
				let headers = new Headers();
				headers.set('Accept', 'application/json');
				const url = 'http://ws.usig.buenosaires.gob.ar/rest/convertir_coordenadas?x='+ punto.getX() +'&y='+ punto.getY() +'&output=lonlat';
				const fetchOptions = {
					method: 'GET',
					headers,
					mode: 'no-cors',
				};

				fetch(url, fetchOptions).then(response => {
					return response.json();
				}).then(jsonData => {
					alert('Respuesta LONLAT: ', jsonData.tipo_resultado);
					if(jsonData.tipo_resultado === 'Ok'){
						document.getElementById('id_ubicacion_coordenadas').value = jsonData.resultado;
						alert('Resultado lonlat correcto: ', jsonData.resultado);
					}
					else {
						alert('No se obtuvieron las coordenadas en formato: lonlat');
					}					
				}).catch((error) => {
  					alert('Error raised while fetching: '+ error.message);
				});
			}
		}
	});

	function updateResumen(radioClicked) {
		const resumen_ul = document.querySelector('#div_id_motivo_resumen > div > ul');
		let li = resumen_ul.querySelector('[data-factor="'+ radioClicked.name +'"]');
		const ul_empty_msg = document.getElementById('resumen-empty-msg');
		
		if(li) { // Si existe un elemento del mismo factor
			if(radioClicked.value === "Sin información") {
				li.remove();
				if(resumen_ul.childElementCount == 0) {
					ul_empty_msg.style.display = 'block';
				}
			} 
			else {
				li.querySelector('.value').innerHTML = radioClicked.value;
			}
		}
		else { // Si no existe, creo un nuevo elemento
			if(ul_empty_msg.style.display != 'none') {
				ul_empty_msg.style.display = 'none';
			}
			li = document.createElement('li');
			li.classList.add('list-group-item');
			li.setAttribute('data-factor', radioClicked.name);
			li.innerHTML = `<span class="factor"><strong>`+ radioClicked.name +`:</strong></span>
							<span class="value"> `+ radioClicked.value +`</span>`;
			li.innerHTML += `<button type="button" class="close" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>`;
			li.querySelector('button').onclick = (event) => { event.stopPropagation(); removeLi(resumen_ul, li, ul_empty_msg)};
			resumen_ul.appendChild(li);
		}
	}

	function removeLi(ul, li, empty_msg) {
		const name = li.getAttribute('data-factor');
		document.querySelector('input[name="'+ name +'"][value="Sin información"]').checked = true;
		li.remove();
		if(ul.childElementCount == 0)
			empty_msg.style.display = 'block';
	};

	function empty_all() {
		document.querySelector('#div_id_motivo_resumen > div > ul').innerHTML = '';
		document.getElementById('resumen-empty-msg').style.display = 'block';
		document.querySelectorAll('[form="none"]').forEach(radio => {
			if(radio.value === "Sin información") {
				radio.checked = true;
			}
		});
	};

	function padLeft(nr, n, str){
		return Array(n-String(nr).length+1).join(str||'0')+nr;
	}

	function formattedDateTime(dateTime) {
		return  padLeft(dateTime.getDate(), 2) +'/'+
				padLeft(dateTime.getMonth() + 1, 2) +'/'+ //possible values [0-11]
				padLeft(dateTime.getFullYear(), 4) +' '+
				padLeft(dateTime.getHours(), 2) +':'+
				padLeft(dateTime.getMinutes(), 2) +':'+
				padLeft(dateTime.getSeconds(), 2)
	};

	// From Django 1.11 Documentation
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie != '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	// Buscando geocodificación de ubicación ingresada
	document.getElementById('id_ubicacion').onblur = (event) => {
		if(event.target.value != '') {
			const splitted = event.target.value.split(' ');
			const calle = splitted[0];
			const 	altura = splitted[1];
			
			let headers = new Headers();
			headers.set('Accept', 'application/json');
			const url = 'http://ws.usig.buenosaires.gob.ar/geocoder/2.2/geocoding?cod_calle='+ calle +'&altura='+ altura;
			const fetchOptions = {
				method: 'GET',
				headers,
				mode: 'no-cors',
			};

			fetch(url, fetchOptions)
			.then(response => {
				response.text()
				.then( text => {
					// TODO: completar coordenadas en el formulario
					console.log('respuesta: '+ text);
					console.log(JSON.stringify(response));
					//document.getElementById('id_ubicacion_coordenadas').value = coordenadas;
				});
			});
		} /*else {
			//alert('ubicación vacía');
		}*/
	}

	document.getElementById('SolicitudForm').onsubmit = function sendSolicitud(event) {
		// 1. Setup the request
		// ================================
		// 1.1 Headers
		let headers = new Headers();
		// Tell the server we want JSON back
		headers.set('Accept', 'application/json');
		// Set Credentials
		headers.set('X-CSRFToken', getCookie("csrftoken"));

		// 1.2 Form Data
		// We need to properly format the submitted fields.
		// Here we will use the same format the browser submits POST forms.
		// You could use a different format, depending on your server, such
		// as JSON or XML.
		let formData = new FormData();
		let formEl = document.getElementById('SolicitudForm');
		for (let i = 0; i < formEl.length; ++i) {
			formData.append(formEl[i].name, formEl[i].value);
		}
		
		// Completar campo MOTIVO en JSON
		const resumen_list = document.querySelector('#div_id_motivo_resumen > div > ul');
		if(resumen_list.childElementCount != 0) {
			let motivo_json = '';
			document.querySelector('#div_id_motivo_resumen > div > ul').childNodes.forEach( node => {
				let factor = node.querySelector('.factor > strong').innerHTML.replace(':', '');
				let valor = node.querySelector('.value').innerHTML.substring(1);
				motivo_json += factor +': ' + valor +',';
			});
			motivo_json = motivo_json.substr(0, motivo_json.length - 1); //Remove last comma
			motivo_json = '{'+ motivo_json +'}';
			formData.append('motivo', motivo_json);
		}

		// 2. Make the request
		// ================================
		let url = 'http://127.0.0.1:8000/api/solicitudes/';
		let fetchOptions = {
			method: 'POST',
			headers,
			body: formData,
			credentials: 'same-origin',
		};

		// 3. Use the response
		// ================================
		fetch(url, fetchOptions)
		// 3.1 Convert the response into JSON-JS object.
		.then(response => {
			response.json()
			// 3.2 Do something with the JSON data
			.then(jsonData => {
				if(response.ok) {
					// Mostrar mensaje de éxito
					document.querySelector('.messages').innerHTML += `
					<div class="alert alert-dismissable fade in alert-success">Auxilio #`+ jsonData['id'] +` fue creado
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					</div>`;

					// Empty Solicitud form
					document.getElementById('SolicitudForm').reset();
					// Reset radio buttons to default
					document.querySelectorAll('[form="none"]').forEach(radio => {
						if(radio.value === "Sin información") {
							radio.checked = true;
						}
					});

					// Switch to auxilios-actuales tab
					$('.nav-tabs a[href="#auxilios-actuales"]').tab('show');
				} else {
					Object.keys(jsonData).map(key => {
						// Mostrar mensaje de error
						document.querySelector('.messages').innerHTML += `
						<div class="alert alert-dismissable fade in alert-danger">`+ key +': '+ jsonData[key] +`
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
						</div>`;
					});
				}
			});
		});
		event.preventDefault();
	};
</script>
{% endblock extra-JS %}