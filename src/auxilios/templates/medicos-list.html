{% extends "baseForm.html" %}
{% load staticfiles %}
{% load rest_framework %}

{% block content %}
<div class="body-header">
    <h1 class="text-center font-bold">Gestión de médicos</h1>
</div>

<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
    <li role="presentation" class="active"><a href="#newMedico" aria-controls="Nuevo medico" role="tab" data-toggle="tab">Alta de médicos</a></li>
    <li role="presentation"><a href="#medicos-actuales" aria-controls="Medicos Actuales" role="tab" data-toggle="tab">Médicos Registrados</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <div role="tabpanel" class="tab-pane fade in active" id="newMedico">
        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading text-center"> PANEL HEADING </div>
            <div class="panel-body">
                <form id="MedicoForm" class="form-group" method='POST' enctype="multipart/form-data" autocomplete="off">{% csrf_token %}
					<div class="col-md-10 col-md-offset-1" id="form-container">
						{% render_form serializer %}
					</div>
				</form>
            </div>
            <div class="panel-footer text-center">
				<div role="group" align="right" aria-label="..."> 
					<button type="reset" form="MedicoForm" id="vaciar_btn" class="btn btn-warning" name="Vaciar" onclick="empty_all()">Vaciar</button>
					<button type="submit" form="MedicoForm" class="btn btn-primary" name="Registrar">Registrar</button>
				</div>
			</div><!-- /panel-footer -->
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="medicos-actuales">
        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading text-center"> PANEL HEADING </div>
            <!-- Table -->
            <table class="table table-responsive table-striped">
                <thead>
                    <tr>
                        <th>DNI</th>
                        <th>Matrícula</th>
                        <th>Apellido</th>
                        <th>Nombre</th>
                        <th>Teléfono</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <nav aria-label="Page navigation" class="text-center">
            <ul class="pagination">
                <li class="disabled">
                    <a href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="active"><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li>
                    <a href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="MedicoDetailModal" tabindex="-1" role="dialog" aria-labelledby="MedicoDetailModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title text-center" id="MedicoDetailModalLabel">Detalle del médico DNI ...</h4>
			</div>
			<div class="modal-body">
				<p><strong>Matrícula: </strong><span id='MedicoDetailModalMatricula'>...</span></p>
				<p>
                    <strong>Nombre completo: </strong><span id='MedicoDetailModalApellido'>...</span>, <span id='MedicoDetailModalNombre'>...</span>
                </p>
				<p><strong>Sexo: </strong><span id='MedicoDetailModalSexo'>...</span></p>
				<p><strong>Teléfono: </strong><span id='MedicoDetailModalTelefono'>...</span></p>
                <p><strong>Registrado: </strong><span id='MedicoDetailModalRegistrado'>...</span></p>
                <p><strong>Última modificación: </strong><span id='MedicoDetailModalModificado'>...</span></p>
				<p><strong>Generador: </strong><span id='MedicoDetailModalGenerador'>...</span></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="MedicoDeleteModal" tabindex="-1" role="dialog" aria-labelledby="MedicoDeleteModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title text-center" id="MedicoDeleteModalLabel">Eliminar médico</h4>
			</div>
			<div class="modal-body text-center">
				<p>¿Está seguro que quiere eliminar al médico con <strong>DNI: <span id='MedicoDeleteModalDNI'>...</span></strong>?</p>
			</div>
			<div class="modal-footer">
                <form id="MedicoDeleteForm" class="form-group" method='DELETE' enctype="multipart/form-data" autocomplete="off">
                    {% csrf_token %}
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
			</div>
		</div>
	</div>
</div>
{% endblock content %}

{% block extra-JS %}
<script src='{% static "js/moment-2.18.1.min.js" %}' type="text/javascript"></script>
<script>
	// Set fields layout
    document.getElementsByName('dni')[0].parentNode.classList.add('col-md-4');
    document.getElementsByName('dni')[0].classList.add('text-center', 'font-bold');
    document.getElementsByName('matricula')[0].parentNode.classList.add('col-md-4', 'col-md-offset-4');
    document.getElementsByName('matricula')[0].classList.add('text-center', 'font-bold');
    document.getElementsByName('apellido')[0].parentNode.classList.add('col-md-6');
    document.getElementsByName('nombre')[0].parentNode.classList.add('col-md-6');
    document.getElementsByName('sexo')[0].parentNode.classList.add('col-md-2', 'col-md-offset-3');
    document.getElementsByName('telefono')[0].parentNode.classList.add('col-md-4');


    // MedicosActualesTab se actualiza al mostrarse
	$('.nav-tabs a[href="#medicos-actuales"]').on('show.bs.tab', event => {
		loadMedicosActuales(document.querySelector('#medicos-actuales > div > table > tbody'), "http://127.0.0.1:8000/api/medicos");
    });
    

    function checkStatus(response) {
		if(response.ok)
			return Promise.resolve(response);
		else
			return Promise.reject(new Error(response.statusText));
    };
    

    function loadMedicosActuales(dest, apiURL) {
		dest.innerHTML = '';
		fetch(apiURL).then(response => {
			return checkStatus(response);
		}).then(response => {
			return response.json();
		}).then(jsonData => {
			jsonData.results.map((medico) => {
				let newRow = dest.insertRow(dest.rows.length);
				const acciones = `
					<button type="button" class="btn btn-transparent btn-xs" data-toggle="modal" data-target="#MedicoDetailModal" title='Detalle'>
						<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
					</button>
					<button type="button" class="btn btn-transparent btn-xs" title='Modificar'>
						<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
					</button>
					<button type="button" class="btn btn-transparent btn-xs" data-toggle="modal" data-target="#MedicoDeleteModal" title='Eliminar'>
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>`
				newRow.innerHTML = `<td>${medico.dni}</td>
									<td>${medico.matricula}</td>
									<td>${medico.apellido}</td>
                                    <td>${medico.nombre}</td>
                                    <td>${medico.telefono}</td>
									<td>${acciones}</td>`;
			});
		}).catch(error => {
			console.log(`Error al realizar fetch a ${apiURL}: ${error.message}`);
		});
    };
    

    /*
	 * MedicoDetailModal Handler
	 */
	$('#MedicoDetailModal').on('show.bs.modal', (event) => {
		const button = $(event.relatedTarget);
		const medico_DNI = button.closest('tr').find('td:eq(0)').text();

		fetch(`http://127.0.0.1:8000/api/medicos/${medico_DNI}`).then(response => {
			return checkStatus(response);
		}).then(response => {
			return response.json();
		}).then(jsonData => {
			document.getElementById('MedicoDetailModalMatricula').innerText = jsonData.matricula;
			document.getElementById('MedicoDetailModalApellido').innerText = jsonData.apellido;
			document.getElementById('MedicoDetailModalNombre').innerText = jsonData.nombre;
			document.getElementById('MedicoDetailModalSexo').innerText = jsonData.sexo;
            document.getElementById('MedicoDetailModalTelefono').innerText = jsonData.telefono;
            document.getElementById('MedicoDetailModalRegistrado').innerText = moment(jsonData.registrado).format('DD/MM/YY HH:mm:ss');
            document.getElementById('MedicoDetailModalModificado').innerText = moment(jsonData.modificado).format('DD/MM/YY HH:mm:ss');
			document.getElementById('MedicoDetailModalGenerador').innerText = jsonData.generador;
		}).catch(error => {
			console.log(`Error al realizar fetch de detalle del médico DNI ${medico_DNI}: ${error.message}`);
		});

		document.getElementById('MedicoDetailModalLabel').innerText = `Detalle del médico DNI ${medico_DNI}`;
    });


    /*
	 * MedicoDetailModal Handler
	 */
	$('#MedicoDeleteModal').on('show.bs.modal', (event) => {
		const button = $(event.relatedTarget);
		const medico_DNI = button.closest('tr').find('td:eq(0)').text();
		document.getElementById('MedicoDeleteModalDNI').innerText = medico_DNI;
    });
    

    /*
	 *    Django Documentarion 1.11 cookie handler
	 *	  from: https://docs.djangoproject.com/en/1.11/ref/csrf/
	 */
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie != '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
    }
    

    document.getElementById('MedicoForm').onsubmit = function sendMedico(event) {
		document.querySelector('.messages').innerHTML = '';

        const header_init = {
            'Accept': 'application/json',
            'X-CSRFToken': getCookie("csrftoken")
        }

		const fetchOptions = {
			method: 'POST',
			headers: new Headers(header_init),
			body: new FormData(document.getElementById('MedicoForm')),
			credentials: 'same-origin'
		};
        
        const url = 'http://127.0.0.1:8000/api/medicos/';

		fetch(url, fetchOptions).then(response => {
            response.json()
            .then(jsonData => {
				if(response.ok) {
					// Mostrar mensaje de éxito
					document.querySelector('.messages').innerHTML = `
					<div class="alert alert-dismissable fade in alert-success">Médico DNI ${jsonData.dni} fue registrado
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					</div>`;

					// Empty Solicitud form
					document.getElementById('MedicoForm').reset();

					// Switch to médicos-actuales Tab
					$('.nav-tabs a[href="#medicos-actuales"]').tab('show');
				} else {
					Object.keys(jsonData).map(key => {
						// Mostrar mensaje de error
						document.querySelector('.messages').innerHTML += `
						<div class="alert alert-dismissable fade in alert-danger">${key}: ${jsonData[key]}
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
						</div>`;
					});
				}
			});
		});
		event.preventDefault(); // Evita el envío POST del botón
		window.scrollTo(0,0); // Scroll a la parte superior de la pantalla
    };
    
    
    document.getElementById('MedicoDeleteForm').onsubmit = function deleteMedico(event) {
		document.querySelector('.messages').innerHTML = '';

        const header_init = {
            'Accept': 'application/json',
            'X-CSRFToken': getCookie("csrftoken")
        }

		const fetchOptions = {
			method: 'DELETE',
			headers: new Headers(header_init),
			/*body: null,*/
			credentials: 'same-origin'
		};
        
        const medico_DNI = document.getElementById('MedicoDeleteModalDNI').innerText;
        const url = `http://127.0.0.1:8000/api/medicos/${medico_DNI}`;

		fetch(url, fetchOptions).then(response => {
            if(response.ok) {
                // Mostrar mensaje de éxito
                document.querySelector('.messages').innerHTML = `
                <div class="alert alert-dismissable fade in alert-success">Médico con DNI: ${medico_DNI} fue eliminado
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                </div>`;
                loadMedicosActuales(document.querySelector('#medicos-actuales > div > table > tbody'), "http://127.0.0.1:8000/api/medicos");
                $('#MedicoDeleteModal').modal('hide');
            } else {
                response.json()
                .then(jsonData => {
                    Object.keys(jsonData).map(key => {
                        // Mostrar mensaje de error
                        document.querySelector('.messages').innerHTML += `
                        <div class="alert alert-dismissable fade in alert-danger">${key}: ${jsonData[key]}
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                        </div>`;
                    });
                });
            }
		});
		event.preventDefault(); // Evita el envío POST del botón
		window.scrollTo(0,0); // Scroll a la parte superior de la pantalla
    };
</script>
{% endblock extra-JS %}